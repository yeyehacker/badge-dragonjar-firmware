name: Build DragonJAR Badge Firmware (Manual IDF Setup)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. INSTALACIÓN MANUAL A PRUEBA DE FALLOS DE ESP-IDF v5.1.1
      # Este paso reemplaza a "uses: espressif/idf-action..."
      - name: Manual Setup and Toolchain Install
        run: |
          # Instalar dependencias necesarias
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev

          # Clonar el repositorio de ESP-IDF (usamos v5.1.1, una versión estable)
          git clone --depth 1 --branch v5.1.1 https://github.com/espressif/esp-idf.git $HOME/esp-idf

          # Instalar toolchain y configurar el entorno
          $HOME/esp-idf/install.sh
          echo "IDF_PATH=$HOME/esp-idf" >> $GITHUB_ENV
          echo "$HOME/esp-idf/export.sh" >> $GITHUB_ENV
          
      # 3. Compila el firmware.
      - name: Build firmware (DragonJAR Badge)
        working-directory: firmware
        run: |
          # Cargar el entorno y compilar con idf.py
          source $HOME/esp-idf/export.sh
          idf.py build

      # 4. Sube los binarios resultantes
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dragonjar-firmware-bin
          path: firmware/build/*.bin
